#!/bin/sh

TOP="//home//chovanak//sqlite"

SRC="\
  $TOP//src//alter.c \
  $TOP//src//analyze.c \
  $TOP//src//attach.c \
  $TOP//src//auth.c \
  $TOP//src//backup.c \
  $TOP//src//bitvec.c \
  $TOP//src//btmutex.c \
  $TOP//src//btree.c \
  $TOP//src//btree.h \
  $TOP//src//btreeInt.h \
  $TOP//src//build.c \
  $TOP//src//callback.c \
  $TOP//src//complete.c \
  $TOP//src//ctime.c \
  $TOP//src//date.c \
  $TOP//src//dbpage.c \
  $TOP//src//dbstat.c \
  $TOP//src//delete.c \
  $TOP//src//expr.c \
  $TOP//src//fault.c \
  $TOP//src//fkey.c \
  $TOP//src//func.c \
  $TOP//src//global.c \
  $TOP//src//hash.c \
  $TOP//src//hash.h \
  $TOP//src//hwtime.h \
  $TOP//src//insert.c \
  $TOP//src//legacy.c \
  $TOP//src//loadext.c \
  $TOP//src//main.c \
  $TOP//src//malloc.c \
  $TOP//src//mem0.c \
  $TOP//src//mem1.c \
  $TOP//src//mem2.c \
  $TOP//src//mem3.c \
  $TOP//src//mem5.c \
  $TOP//src//memdb.c \
  $TOP//src//memjournal.c \
  $TOP//src//msvc.h \
  $TOP//src//mutex.c \
  $TOP//src//mutex.h \
  $TOP//src//mutex_noop.c \
  $TOP//src//mutex_unix.c \
  $TOP//src//mutex_w32.c \
  $TOP//src//notify.c \
  $TOP//src//os.c \
  $TOP//src//os.h \
  $TOP//src//os_common.h \
  $TOP//src//os_setup.h \
  $TOP//src//os_unix.c \
  $TOP//src//os_win.c \
  $TOP//src//os_win.h \
  $TOP//src//pager.c \
  $TOP//src//pager.h \
  $TOP//src//parse.y \
  $TOP//src//pcache.c \
  $TOP//src//pcache.h \
  $TOP//src//pcache1.c \
  $TOP//src//pragma.c \
  $TOP//src//pragma.h \
  $TOP//src//prepare.c \
  $TOP//src//printf.c \
  $TOP//src//random.c \
  $TOP//src//resolve.c \
  $TOP//src//rowset.c \
  $TOP//src//select.c \
  $TOP//src//status.c \
  $TOP//src//shell.c.in \
  $TOP//src//sqlite.h.in \
  $TOP//src//sqlite3ext.h \
  $TOP//src//sqliteInt.h \
  $TOP//src//sqliteLimit.h \
  $TOP//src//table.c \
  $TOP//src//tclsqlite.c \
  $TOP//src//threads.c \
  $TOP//src//tokenize.c \
  $TOP//src//treeview.c \
  $TOP//src//trigger.c \
  $TOP//src//utf.c \
  $TOP//src//update.c \
  $TOP//src//upsert.c \
  $TOP//src//util.c \
  $TOP//src//vacuum.c \
  $TOP//src//vdbe.c \
  $TOP//src//vdbe.h \
  $TOP//src//vdbeapi.c \
  $TOP//src//vdbeaux.c \
  $TOP//src//vdbeblob.c \
  $TOP//src//vdbemem.c \
  $TOP//src//vdbesort.c \
  $TOP//src//vdbetrace.c \
  $TOP//src//vdbevtab.c \
  $TOP//src//vdbeInt.h \
  $TOP//src//vtab.c \
  $TOP//src//vxworks.h \
  $TOP//src//wal.c \
  $TOP//src//wal.h \
  $TOP//src//walker.c \
  $TOP//src//where.c \
  $TOP//src//wherecode.c \
  $TOP//src//whereexpr.c \
  $TOP//src//whereInt.h \
  $TOP//src//window.c
  $TOP//ext//fts1//fts1.c \
  $TOP//ext//fts1//fts1.h \
  $TOP//ext//fts1//fts1_hash.c \
  $TOP//ext//fts1//fts1_hash.h \
  $TOP//ext//fts1//fts1_porter.c \
  $TOP//ext//fts1//fts1_tokenizer.h \
  $TOP//ext//fts1//fts1_tokenizer1.c \
  $TOP//ext//fts2//fts2.c \
  $TOP//ext//fts2//fts2.h \
  $TOP//ext//fts2//fts2_hash.c \
  $TOP//ext//fts2//fts2_hash.h \
  $TOP//ext//fts2//fts2_icu.c \
  $TOP//ext//fts2//fts2_porter.c \
  $TOP//ext//fts2//fts2_tokenizer.h \
  $TOP//ext//fts2//fts2_tokenizer.c \
  $TOP//ext//fts2//fts2_tokenizer1.c \
  $TOP//ext//fts3//fts3.c \
  $TOP//ext//fts3//fts3.h \
  $TOP//ext//fts3//fts3Int.h \
  $TOP//ext//fts3//fts3_aux.c \
  $TOP//ext//fts3//fts3_expr.c \
  $TOP//ext//fts3//fts3_hash.c \
  $TOP//ext//fts3//fts3_hash.h \
  $TOP//ext//fts3//fts3_icu.c \
  $TOP//ext//fts3//fts3_porter.c \
  $TOP//ext//fts3//fts3_snippet.c \
  $TOP//ext//fts3//fts3_tokenizer.h \
  $TOP//ext//fts3//fts3_tokenizer.c \
  $TOP//ext//fts3//fts3_tokenizer1.c \
  $TOP//ext//fts3//fts3_tokenize_vtab.c \
  $TOP//ext//fts3//fts3_unicode.c \
  $TOP//ext//fts3//fts3_unicode2.c \
  $TOP//ext//fts3//fts3_write.c \
  $TOP//ext//icu//sqliteicu.h \
  $TOP//ext//icu//icu.c \
  $TOP//ext//rtree//rtree.h \
  $TOP//ext//rtree//rtree.c \
  $TOP//ext//rtree//geopoly.c \
  $TOP//ext//session//sqlite3session.c \
  $TOP//ext//session//sqlite3session.h \
  $TOP//ext//userauth//userauth.c \
  $TOP//ext//userauth//sqlite3userauth.h \
  $TOP//ext//rbu//sqlite3rbu.h \
  $TOP//ext//rbu//sqlite3rbu.c \
  $TOP//ext//misc//json1.c \
  $TOP//ext//misc//stmt.c \
  keywordhash.h \
  opcodes.c \
  opcodes.h \
  parse.c \
  parse.h \
  config.h \
  shell.c \
  sqlite3.h"

tclsh8.6 $TOP/tool/mksqlite3h.tcl $TOP >sqlite3.h
gcc  -g -O2 -o mkkeywordhash -DSQLITE_ENABLE_MATH_FUNCTIONS  $TOP/tool/mkkeywordhash.c
./mkkeywordhash >keywordhash.h
gcc  -g -O2 -o lemon $TOP/tool/lemon.c
cp $TOP/tool/lempar.c .
cp $TOP/src/parse.y .
./lemon -DSQLITE_ENABLE_MATH_FUNCTIONS  -S parse.y
cat parse.h $TOP/src/vdbe.c | tclsh8.6 $TOP/tool/mkopcodeh.tcl >opcodes.h
tclsh8.6 $TOP/tool/mkopcodec.tcl opcodes.h >opcodes.c
tclsh8.6 $TOP/tool/mkshellc.tcl >shell.c
cp $TOP/ext/fts5/fts5parse.y .
rm -f fts5parse.h
./lemon  -S fts5parse.y
tclsh8.6 $TOP/ext/fts5/tool/mkfts5c.tcl
cp $TOP/ext/fts5/fts5.h .
rm -rf tsrc
mkdir tsrc

cp -f $SRC tsrc
rm tsrc/sqlite.h.in tsrc/parse.y
tclsh8.6 $TOP/tool/vdbe-compress.tcl  <tsrc/vdbe.c >vdbe.new
mv vdbe.new tsrc/vdbe.c
cp fts5.c fts5.h tsrc
touch .target_source
tclsh8.6 $TOP/tool/mksqlite3c.tcl
cp tsrc/sqlite3ext.h .
cp $TOP/ext/session/sqlite3session.h .

CFLAGS="gcc -g -O2 -DSQLITE_OS_UNIX=1 -I. -I$TOP//src -I$TOP//ext//rtree -I$TOP//ext//icu -I$TOP//ext//fts3 -I$TOP//ext//async -I$TOP//ext//session -I$TOP//ext//userauth -D_HAVE_SQLITE_CONFIG_H -DBUILD_sqlite -DNDEBUG -I//usr//include//tcl8.6 -DSQLITE_THREADSAFE=1 -DSQLITE_ENABLE_MATH_FUNCTIONS  -DSQLITE_HAVE_ZLIB=1"

./libtool --mode=compile --tag=CC $CFLAGS -DSQLITE_TEMP_STORE=1 -c sqlite3.c
./libtool --mode=link $CFLAGS -no-undefined -o libsqlite3.la sqlite3.lo -lm -ldl -lz -lpthread -rpath "//usr//local//lib" -version-info "8:6:8"
./libtool --mode=link $CFLAGS -DHAVE_READLINE=1 -I/usr/include/readline -DHAVE_EDITLINE=0 -DSQLITE_ENABLE_JSON1 -DSQLITE_ENABLE_FTS4 -DSQLITE_ENABLE_RTREE -DSQLITE_ENABLE_EXPLAIN_COMMENTS -DSQLITE_ENABLE_UNKNOWN_SQL_FUNCTION -DSQLITE_ENABLE_STMTVTAB -DSQLITE_ENABLE_DBPAGE_VTAB -DSQLITE_ENABLE_DBSTAT_VTAB -DSQLITE_ENABLE_BYTECODE_VTAB -DSQLITE_ENABLE_OFFSET_SQL_FUNC -DSQLITE_ENABLE_DESERIALIZE -o sqlite3 \
	shell.c sqlite3.c \
	-lreadline -lncurses  -lm -ldl -lz -lpthread   -rpath "//usr//local//lib"

./libtool --mode=compile --tag=CC $CFLAGS -DUSE_TCL_STUBS=1 -c $TOP/src/tclsqlite.c
./libtool --mode=link $CFLAGS   -no-undefined -o libtclsqlite3.la tclsqlite.lo \
	libsqlite3.la -L/usr/lib/x86_64-linux-gnu -ltclstub8.6 -lm -ldl -lz -lpthread   \
	-rpath "//usr//share//tcltk//tcl8.6//sqlite3" \
	-version-info "8:6:8" \
	-avoid-version