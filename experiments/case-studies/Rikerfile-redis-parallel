#!/bin/bash

# Move to the src directory
cd src

# Regenerate the release.h file
./mkreleasehdr.sh > /dev/null

CFLAGS="-pedantic -DREDIS_STATIC= -std=c11 -Wall -W -Wno-missing-field-initializers -O2 -g -ggdb -DUSE_JEMALLOC"
INCLUDES="-I../deps/hiredis -I../deps/linenoise -I../deps/lua/src -I../deps/hdr_histogram -I../deps/jemalloc/include"
LIBS="../deps/hiredis/libhiredis.a ../deps/lua/src/liblua.a ../deps/hdr_histogram/hdr_histogram.o ../deps/linenoise/linenoise.o ../deps/jemalloc/lib/libjemalloc.a -lm -lpthread -ldl"

# Build redis-server
SRC="adlist.c quicklist.c ae.c anet.c dict.c server.c sds.c zmalloc.c lzf_c.c lzf_d.c pqsort.c zipmap.c sha1.c ziplist.c release.c networking.c util.c object.c db.c replication.c rdb.c t_string.c t_list.c t_set.c t_zset.c t_hash.c config.c aof.c pubsub.c multi.c debug.c sort.c intset.c syncio.c cluster.c crc16.c endianconv.c slowlog.c scripting.c bio.c rio.c rand.c memtest.c crcspeed.c crc64.c bitops.c sentinel.c notify.c setproctitle.c blocked.c hyperloglog.c latency.c sparkline.c redis-check-rdb.c redis-check-aof.c geo.c lazyfree.c module.c evict.c expire.c geohash.c geohash_helper.c childinfo.c defrag.c siphash.c rax.c t_stream.c listpack.c localtime.c lolwut.c lolwut5.c lolwut6.c acl.c gopher.c tracking.c connection.c tls.c sha256.c timeout.c setcpuaffinity.c monotonic.c mt19937-64.c"
#gcc $CFLAGS -o ../redis-server $SRC $INCLUDES $LIBS
OBJ=""
for f in $SRC
do
  gcc $CFLAGS -o $f.o -c $f $INCLUDES &
  OBJ="$OBJ $f.o"
done
wait
gcc $CFLAGS -o ../redis-server $OBJ $LIBS
rm $OBJ

# Build redis-cli
SRC="anet.c adlist.c dict.c redis-cli.c zmalloc.c release.c ae.c redisassert.c crcspeed.c crc64.c siphash.c crc16.c monotonic.c cli_common.c mt19937-64.c"
#gcc $CFLAGS -o ../redis-cli $SRC $INCLUDES $LIBS
OBJ=""
for f in $SRC
do
  gcc $CFLAGS -o $f.o -c $f $INCLUDES &
  OBJ="$OBJ $f.o"
done
wait
gcc $CFLAGS -o ../redis-cli $OBJ $LIBS
rm $OBJ

# Build redis-benchmark
SRC="ae.c anet.c redis-benchmark.c adlist.c dict.c zmalloc.c redisassert.c release.c crcspeed.c crc64.c siphash.c crc16.c monotonic.c cli_common.c mt19937-64.c"
#gcc $CFLAGS -o ../redis-benchmark $SRC $INCLUDES $LIBS
OBJ=""
for f in $SRC
do
  gcc $CFLAGS -o $f.o -c $f $INCLUDES &
  OBJ="$OBJ $f.o"
done
wait
gcc $CFLAGS -o ../redis-benchmark $OBJ $LIBS
rm $OBJ
