#!/bin/sh

# Move to the src directory
cd src

# Regenerate the release.h file
GIT_SHA1=`(git show-ref --head --hash=8 2> /dev/null || echo 00000000) | head -n1`
GIT_DIRTY=`git diff --no-ext-diff 2> /dev/null | wc -l`
BUILD_ID=`uname -n`"-"`date +%s`
echo "#define REDIS_GIT_SHA1 \"$GIT_SHA1\"" > release.h
echo "#define REDIS_GIT_DIRTY \"$GIT_DIRTY\"" >> release.h
echo "#define REDIS_BUILD_ID \"$BUILD_ID\"" >> release.h

CFLAGS="-pedantic -DREDIS_STATIC= -std=c11 -Wall -W -Wno-missing-field-initializers -O2 -g -ggdb -I../deps/hiredis -I../deps/linenoise -I../deps/lua/src -I../deps/hdr_histogram -DUSE_JEMALLOC -I../deps/jemalloc/include"
LDFLAGS="-g -ggdb -rdynamic ../deps/hiredis/libhiredis.a ../deps/lua/src/liblua.a ../deps/hdr_histogram/hdr_histogram.o ../deps/linenoise/linenoise.o ../deps/jemalloc/lib/libjemalloc.a -lm -lpthread -ldl"

# Build redis-server
SRC="adlist.c quicklist.c ae.c anet.c dict.c server.c sds.c zmalloc.c lzf_c.c lzf_d.c pqsort.c zipmap.c sha1.c ziplist.c release.c networking.c util.c object.c db.c replication.c rdb.c t_string.c t_list.c t_set.c t_zset.c t_hash.c config.c aof.c pubsub.c multi.c debug.c sort.c intset.c syncio.c cluster.c crc16.c endianconv.c slowlog.c scripting.c bio.c rio.c rand.c memtest.c crcspeed.c crc64.c bitops.c sentinel.c notify.c setproctitle.c blocked.c hyperloglog.c latency.c sparkline.c redis-check-rdb.c redis-check-aof.c geo.c lazyfree.c module.c evict.c expire.c geohash.c geohash_helper.c childinfo.c defrag.c siphash.c rax.c t_stream.c listpack.c localtime.c lolwut.c lolwut5.c lolwut6.c acl.c gopher.c tracking.c connection.c tls.c sha256.c timeout.c setcpuaffinity.c monotonic.c mt19937-64.c"
gcc $CFLAGS -o redis-server $SRC $LDFLAGS
install redis-server redis-sentinel
install redis-server redis-check-aof
install redis-server redis-check-rdb

# Build redis-cli
SRC="anet.c adlist.c dict.c redis-cli.c zmalloc.c release.c ae.c crcspeed.c crc64.c siphash.c crc16.c monotonic.c cli_common.c mt19937-64.c"
gcc $CFLAGS -o redis-cli $SRC $LDFLAGS

# Build redis-benchmark
SRC="ae.c anet.c redis-benchmark.c adlist.c dict.c zmalloc.c release.c crcspeed.c crc64.c siphash.c crc16.c monotonic.c cli_common.c mt19937-64.c"
gcc $CFLAGS -o redis-benchmark $SRC $LDFLAGS
